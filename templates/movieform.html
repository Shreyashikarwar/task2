<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dynamic Input Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
</head>

<body>
    <div>
        <nav class="navbar bg-body-tertiary">
            <div class="container">
                <a class="navbar-brand">Movies</a>
                <form class="d-flex" role="search">
                    <button class="btn btn-success" type="submit">
                        <a href="/movie" style="all: unset;">Create Movie</a>
                    </button>
                </form>
            </div>
        </nav>
        <div class="container mt-5">
            <div class="d-flex justify-content-between align-items-center">
                <h3>Create Movie</h3>
                <button type="button" class="btn btn-primary">
                    <a href="/movie/list" style="all: unset;">Movie List</a>
                </button>
            </div>

            <form id="myForm" method="post" class="mt-5">
                <div class="row">
                    <div class="col-6 mb-3">
                        <label for="name" class="form-label">Movie Name</label>
                        <input type="text" required class="form-control" id="name" name="name">
                    </div>
                    <div class="col-6 mb-3">
                        <label for="duration" class="form-label">Movie Duration(in Mins)</label>
                        <input type="number" required class="form-control" id="duration" name="duration">
                    </div>
                </div>
                <hr />
                <div id="cast-container">
                    <div id="cast-1">
                        <div class="d-flex justify-content-between align-items-center my-3">
                            <div class="bg-black text-white text-center px-5 py-1">1. Casts Details</div>
                            <div> 
                                <button onclick="removeEl('cast', 1)" type="button" class="btn btn-info">Remove Cast 1</button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-4 mb-3">
                                <label for="cast_name" class="form-label">Cast Name</label>
                                <input type="text" required class="form-control cast-1" id="cast_name" name="cast_name">
                            </div>
                            <div class="col-4 mb-3">
                                <label for="castGender" class="form-label">Cast Gender</label>
                                <select name="gender" required id="name" class="form-select cast-1" aria-label="Select Gender">
                                    <option selected>-- Select Gender --</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                                <!-- <input type="number" class="form-control" id="castGender"> -->
                            </div>
                            <div class="col-4 mb-3">
                                <label for="character_name" class="form-label">Cast Character</label>
                                <input type="text" required class="form-control cast-1" id="character_name" name="character_name">
                            </div>
                        </div>
                        <div class="mx-5">
                            <div class="row">
                                <div class="bg-info text-light col-2 text-center">Dialouge List</div>
                            </div>
                            <div id="dialouges-container-for-cast-1">
                                <div id="dialouge-1" class="row mt-3">
                                    <div class="col-4 mb-3">
                                        <label for="character_name" class="form-label">Cast Character</label>
                                        <input type="text" required class="form-control" id="character_name" name="character_name">
                                    </div>
                                    <div class="col-6 mb-3 d-block">
                                        <label for="dialouge" class="form-label">Dialouge</label>
                                        <textarea name="dialouge" required id="dialouge" class="w-100 cast-1-dialouge-1" rows="4"></textarea>
                                    </div>
                                    <div class="col-6 mb-3 ">
                                        <div class="d-flex">
                                            <div class="w-100">
                                                <label for="start_time" class="form-label">Start Time</label>
                                                <input type="text" required class="form-control cast-1-dialouge-1" id="start_time" placeholder="00:00:00:00" required pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}:[0-9]{2}" name="start_time">
                                            </div>
                                            <div class="w-100">
                                                <label for="end_time" class="form-label">End Time</label>
                                                <input type="text"required class="form-control cast-1-dialouge-1" id="end_time" placeholder="00:00:00:00" required pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}:[0-9]{2}" name="end_time">
                                            </div>
                                        </div>
                                        <div class="text-center mx-auto mt-3">
                                            <button onclick="removeEl('dialouge', 1)" type="button" class="btn btn-warning">Remove Dialouge</button>
                                        </div>
                                    </div>
                                    <div class="col-3 mb-3">
                                        <button onclick="addNewDialouge()" type="button" class="btn btn-info">Add New Dialouge
                                            For Cast 1</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <hr/>
                <div class="text-center">
                    <button type="button" class="btn btn-success me-1 rounded-0" onclick="addNewCast()">Add New Cast</button>
                    <button type="button" class="btn btn-primary mx-1 rounded-0" onclick="createMovie()">Create Movie</button>
                    <button type="button" class="btn btn-danger ms-1 rounded-0">Reset</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Retrieve data from session storage
            const userDataJson = sessionStorage.getItem('userData');
            
            const userData = JSON.parse(userDataJson);
            console.log(userData)
        //     // Display the data on the target page
        //     const displayElement = document.getElementById('displayData');
        //     displayElement.innerHTML = `
        //         <h2>Received Data:</h2>
        //         <p>Name: ${userData.name}</p>
        //         <p>Age: ${userData.age}</p>
        //         <p>City: ${userData.city}</p>
        //     `;
        });
        function addNewCast(){
            const container = document.getElementById('cast-container');
            const div = document.createElement("div");
            const castNo = container.childElementCount + 1
            div.id = 'cast-' + castNo
            div.classList.add('mt-3')
            div.innerHTML = `
            <div class="d-flex justify-content-between align-items-center my-3">
                        <div class="bg-black text-white text-center px-5 py-1">${castNo}. Casts Details</div>
                        <div> 
                            <button onclick="removeEl('cast', ${castNo})" type="button" class="btn btn-info">Remove Cast ${castNo}</button>
                        </div>
                    </div>
            <div class="row">
                        <div class="col-4 mb-3">
                            <label for="cast_name" class="form-label">Cast Name</label>
                            <input type="text" class="form-control cast-${castNo}" id="cast_name" name="cast_name">
                        </div>
                        <div class="col-4 mb-3">
                            <label for="castGender" class="form-label">Cast Gender</label>
                            <select name="gender" id="name" class="form-select cast-${castNo}" aria-label="Select Gender">
                                <option selected>-- Select Gender --</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                            <!-- <input type="number" class="form-control cast-${castNo}" id="castGender"> -->
                        </div>
                        <div class="col-4 mb-3">
                            <label for="character_name" class="form-label">Cast Character</label>
                            <input type="text" class="form-control cast-${castNo}" id="character_name" name="character_name">
                        </div>
                    </div>
                    <div class="mx-5">
                        <div class="row">
                            <div class="bg-info text-light col-2 text-center">Dialouge List</div>
                        </div>
                        <div id="dialouges-container-for-cast-${castNo}">
                            <div id="dialouge-1" class="row mt-3">
                                <div class="col-6 mb-3 d-block">
                                    <label for="dialouge" class="form-label">Dialouge</label>
                                    <textarea name="dialouge" id="dialouge" class="w-100 cast-${castNo}-dialouge-1" rows="4"></textarea>
                                </div>
                                <div class="col-6 mb-3 ">
                                    <div class="d-flex">
                                        <div class="w-100">
                                            <label for="start_time" class="form-label">Start Time</label>
                                            <input type="time" class="form-control cast-${castNo}-dialouge-1" id="start_time" name="start_time">
                                        </div>
                                        <div class="w-100">
                                            <label for="end_time" class="form-label">End Time</label>
                                            <input type="time" class="form-control cast-${castNo}-dialouge-1" id="end_time" name="end_time">
                                        </div>
                                    </div>
                                    <div class="text-center mx-auto mt-3">
                                        <button type="button" class="btn btn-warning">Remove Dialouge</button>
                                    </div>
                                </div>
                                <div class="col-3 mb-3">
                                    <button onclick="addNewDialouge(${castNo})" type="button" class="btn btn-info">Add New Dialouge
                                        For Cast ${castNo}</button>
                                </div>
                            </div>
                        </div>
                    </div>
            `
                    
            container.appendChild(div)
        }

        function addNewDialouge(castNo = 1) {
            console.log(castNo);
            const container = document.getElementById('dialouges-container-for-cast-' + castNo);
            const div = document.createElement("div");
            const count = container.childElementCount + 1
            div.id = 'dialouge-' + ( container.childElementCount + 1);
            div.classList.add('row', 'mt-3')
            div.innerHTML = ` 
                            <div class="col-4 mb-3">
                                        <label for="character_name" class="form-label">Cast Character</label>
                                        <input type="text" class="form-control"cast-${castNo}-dialouge-${count}" id="character_name" name="character_name">
                            </div>
                            <div class="col-6 mb-3 d-block">
                                <label for="dialouge" class="form-label">Dialouge</label>
                                <textarea name="dialouge" id="dialouge" class="w-100 cast-${castNo}-dialouge-${count}" rows="4"></textarea>
                            </div>
                            <div class="col-6 mb-3 ">
                                <div class="d-flex">
                                    <div class="w-100">
                                        <label for="start_time" class="form-label">Start Time</label>
                                        <input type="time" class="form-control cast-${castNo}-dialouge-${count}" id="start_time" name="start_time">
                                    </div>
                                    <div class="w-100">
                                        <label for="end_time" class="form-label">End Time</label>
                                        <input type="time" class="form-control cast-${castNo}-dialouge-${count}" id="end_time" name="end_time">
                                    </div>
                                </div>
                                <div class="text-center mx-auto mt-3">
                                    <button onclick="removeEl('dialouge', ${container.childElementCount + 1})" type="button" class="btn btn-warning">Remove Dialouge</button>
                                </div>
                            </div>
                            <div class="col-3 mb-3">
                                <button onclick="addNewDialouge(${castNo})" type="button" class="btn btn-info">Add New Dialouge For Cast ${castNo}</button>
                            </div>`;

            container.appendChild(div)
        }

        function removeEl(elName, elNumber){
            const el = document.getElementById(`${elName}-${elNumber}`)
            el.remove()
        }

        function createMovie(){
            const payload = {
                name:"",
                duration:"",
                casting:[],
                dialogue:[]
            }

            payload.name = document.getElementById("name").value
            payload.duration = document.getElementById("duration").value;

            const container = document.getElementById('cast-container');
            
            Array.from(container.children).forEach((child, i)=> {
                const castContainer = document.getElementsByClassName('cast-' + (i+1));
                if(castContainer.length){
                        payload.casting.push({
                            cast_name:castContainer.cast_name.value,
                            gender:castContainer.gender.value,
                            character_name:castContainer.character_name.value
                        })
                        
                        const dialogueContainer = document.getElementById('dialouges-container-for-cast-' + (i+1));
                        Array.from(dialogueContainer.children).forEach((child, index)=>{
                            const dialogueEls = document.getElementsByClassName(`cast-${(i+1)}-dialouge-${(index+1)}`);
                            if(dialogueEls.length){
                                payload.dialogue.push({
                                    dialogue:dialogueEls.dialouge.value,
                                    start_time:dialogueEls.start_time.value,
                                    end_time:dialogueEls.end_time.value,
                                    character_name:castContainer.character_name.value
                                })
                            }
                        })
                }
            });
            console.log(payload)
            const jsonData = JSON.stringify(payload);
            
            // Set up the fetch request
            const fetch_api = fetch('http://127.0.0.1:8000/movie/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json', 
            },
            body: jsonData,
            })
            .then(response => {
            if (response.ok) {
                window.location.href = 'http://127.0.0.1:8000/movie/list';
            } else {
                console.error('Failed to fetch data:', response.statusText);
            }
            })
            .catch(error => {
            console.error('Error:', error);
            });
            // return fetch_api.json()
            // return JSON.stringify(payload)


            // for (var pair of formData.entries()) {
            //     console.log(formData);
            //     console.log(pair[0] + ': ' + pair[1]);
            // }
        }
      
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>

</html>

